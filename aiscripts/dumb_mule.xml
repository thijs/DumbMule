<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="dumbmule" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://x4libonline.ddns.net\libraries\aiscripts.xsd" version="5">
  <!-- Setup context menu order -->
  <order id="DumbMule" name="M5- Dumb Mule"
         description="Dumbly ferries supplies between stations"
         category="trade" infinite="true">
    <params>
      <!-- menu option: Source Station (Define Source Station) -->
      <param name="sourceStation" type="object" text="Source Station" comment="The source station">
        <input_param name="class" value="[class.station]" />
      </param>
      <!-- menu option: Target Station (Defines destination target) -->
      <param name="targetStation" type="object" text="Target Station" comment="The recipient station">
        <input_param name="class" value="[class.station]" />
      </param>
      <!-- menu option: Two-way Trade (Forces trading back and forth between the stations if used) -->
      <param name="twoWay" type="bool" default="true"
             text="Two-way trade" comment="Trades back and forth between stations" />

      <!-- <!-\- menu option: WareBasket List-\-> -->
      <!-- <param name="specialWareBasket"    type="list" default="[]"
           text="Wares (all by default)"       comment="Warebasket"> -->
      <!--  <input_param name="type"     value="'ware'" /> -->
      <!--  <input_param name="cancarry" value="this.ship" /> -->
      <!-- </param> -->

    </params>
    <requires>
      <match shiptype="shiptype.lasertower" negate="true" />
    </requires>
  </order>

  <interrupts>
    <handler ref="AttackHandler" />
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler" />
    <handler ref="InspectedHandler" />
    <handler ref="FoundAbandonedHandler" />
    <handler ref="ResupplyHandler" />
    <handler ref="JobRemoveRequestHandler" />
    <handler ref="TargetInvalidHandler" />
  </interrupts>

  <init>
    <set_value name="$debugchance" exact="100" />
    <set_value name="$object" exact="this.assignedcontrolled" />
    <set_order_syncpoint_reached order="this.ship.order" />
    <set_command_action commandaction="commandaction.searchingtrades" />
    <do_if value="($sourceStation.owner == this.ship.owner)">
      <set_object_commander object="this.ship" commander="$sourceStation" assignment="assignment.trade" />
    </do_if>
    <set_value name="$debugFileName" exact="this.ship.idcode + ' dumbmule-' + player.age" />
  </init>

  <attention min="unknown">
    <actions>
      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                     text="'starting log file'" append="false" output="false" />

      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                     text="'  Dumb Mule      : [' + this.ship.idcode + '] ' + this.ship.name" />
      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                     text="'  Source station : [' + $sourceStation.idcode + '] ' + $sourceStation.name" />
      <do_if value="$sourceStation.resources.count">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'    resources  : ' + $sourceStation.resources.list" />
      </do_if>
      <do_if value="$sourceStation.tradewares.count">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'    tradewares  : ' + $sourceStation.tradewares.list" />
      </do_if>
      <do_if value="$sourceStation.products.count">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'    products  : ' + $sourceStation.products.list" />
      </do_if>
      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                     text="'  Target station : [' + $targetStation.idcode + '] ' + $targetStation.name" />
      <do_if value="$targetStation.resources.count">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'    resources  : ' + $targetStation.resources.list" />
      </do_if>
      <do_if value="$targetStation.tradewares.count">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'    tradewares  : ' + $targetStation.tradewares.list" />
      </do_if>
      <do_if value="$targetStation.products.count">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'    products  : ' + $targetStation.products.list" />
      </do_if>
      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                     text="'---------------------------------------------------------------'" />


      <set_value name="$srcStation" exact="$sourceStation" />
      <set_value name="$dstStation" exact="$targetStation" />

      <label name="initializeTradeOffers" />

      <set_value name="$initId" exact="'014:' + $srcStation.idcode + '+' + $dstStation.idcode" />
      <do_if value="global.$mdm_trackWarehousesSet.indexof.{$initId}" negate="true">

        <set_value name="$wares" exact="[]" />

        <do_if value="$srcStation.products.count">
          <do_all exact="$srcStation.products.count" counter="$i">
            <set_value name="$product" exact="$srcStation.products.{$i}" />

            <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                           text="'src product: ' + $product.id" />

            <do_if value="$wares.indexof.{$product}" negate="true">
              <append_to_list name="$wares" exact="$product" />
            </do_if>
          </do_all>
        </do_if>

        <do_if value="$twoWay">
          <do_if value="$srcStation.resources.count">
            <do_all exact="$srcStation.resources.count" counter="$i">
              <set_value name="$resource" exact="$srcStation.resources.{$i}" />

              <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                             text="'src resource: ' + $resource.id" />

              <do_if value="$wares.indexof.{$resource}" negate="true">
                <append_to_list name="$wares" exact="$resource" />
              </do_if>
            </do_all>
          </do_if>
        </do_if>

        <do_all exact="$wares.count" counter="$i">
          <set_value name="$ware" exact="$wares.{$i}" />

          <!-- SKIP ENERGY CELLS, MED, AND FOOD -->
          <do_if value="$ware.id == 'energycells'">
            <continue/>
          </do_if>
          <do_if value="$ware.id == 'foodrations'">
            <continue/>
          </do_if>
          <do_if value="$ware.id == 'medicalsupplies'">
            <continue/>
          </do_if>

          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'adding tradeOffer for: ' + $ware" />
          <add_tradeware object="$dstStation" ware="$ware"
                         allowbuy="true" allowsell="true" lockavgprice="false" />

          <!-- show notification on warehouse created and call create log-book entry. -->
          <create_list name="$notif" />
          <!-- message needs to be short or it won't fit -->
          <append_to_list name="$notif" exact="'DumbMule ' + this.ship.idcode" />
          <append_to_list name="$notif" exact="'I added tradeware: ' + $ware.id " />
          <!-- <show_notification text="$notif" sound="null" /> -->
          <write_to_logbook category="general" title="'dumbmule: ' + this.ship.knownname +
                                                      ' ( ' + this.ship.idcode + ' )'"
                            interaction="showonmap" object="this.ship"
                            text="'Added tradeware ' + $ware + ' to ' + $dstStation.name + ' '" />
          <remove_value name="$notif" />

          <!-- <wait min="10ms" max="100ms" comment="Avoid performance peaks with find functions" /> -->

        </do_all>

        <append_to_list name="global.$mdm_trackWarehousesSet" exact="$initId" />

        <remove_value name="$wares" />

      </do_if>


      <label name="start" />

      <set_value name="$wareBasket" exact="[]" />

      <!-- get existing trade offers from target -->
      <wait min="10ms" max="100ms" comment="Avoid performance peaks with find functions" />
      <find_buy_offer buyer="$dstStation" result="$tradeOffers" multiple="true" excludeempty="false">
      </find_buy_offer>

      <wait min="10ms" max="100ms" comment="Avoid performance peaks with find functions" />
      <find_sell_offer seller="$dstStation" result="$whSellOffers" multiple="true" excludeempty="false">
      </find_sell_offer>

      <!-- <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$tradeOffers"
           excludeempty="false" multiple="true"> -->
      <!--      <match_buyer> -->
      <!--        <match_gate_distance object="$srcStation" min="0"> -->
      <!--          <blacklist group="blacklistgroup.civilian" object="this.ship" /> -->
      <!--        </match_gate_distance> -->
      <!--      </match_buyer> -->
      <!-- </find_buy_offer> -->
      <wait min="5ms" max="15ms" />

      <!-- product wares -->
      <do_all exact="$srcStation.products.count" counter="$cts">
        <set_value name="$addingWare" exact="$srcStation.products.{$cts}" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'scanning ware: ' + $addingWare + ' [' + $addingWare.id + ']'" />

        <!-- SKIP ENERGY CELLS -->
        <do_if value="$addingWare.id == 'energycells'">
          <continue/>
        </do_if>

        <do_if value="$wareBasket.indexof.{$addingWare}" negate="true">

          <!-- get it as offer -->
          <set_value name="$offerFound" exact="false" />
          <do_all exact="$tradeOffers.count" counter="$n">

            <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                 text="'tradeOffer: ' + $tradeOffers.{$n}.ware +
                       ' [' + $tradeOffers.{$n}.ware.id + ']'" />

            <do_if value="$addingWare == $tradeOffers.{$n}.ware">
              <set_value name="$offerFound" exact="true" />
              <break />
            </do_if>
          </do_all>

          <!-- does it also have sell offer? -->
          <set_value name="$sellOfferFound" exact="false" />
          <do_all exact="$whSellOffers.count" counter="$n">

            <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                           text="'sellOffer: ' + $whSellOffers.{$n}.ware +
                                 ' [' + $whSellOffers.{$n}.ware.id + ']'" />

            <do_if value="$addingWare == $whSellOffers.{$n}.ware">
              <set_value name="$sellOfferFound" exact="true" />
              <break />
            </do_if>
          </do_all>

          <do_if value="(not $offerFound) or (not $sellOfferFound)">

            <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                           text="'no full tradeOffer: adding now for ' + $addingWare" />
            <add_tradeware object="$dstStation" ware="$addingWare"
                           allowbuy="true" allowsell="true" lockavgprice="false" />

            <!-- show notification on warehouse created and call create log-book entry. -->
            <create_list name="$notif" />
            <!-- message needs to be short or it won't fit -->
            <append_to_list name="$notif" exact="'DumbMule ' + this.ship.idcode" />
            <append_to_list name="$notif" exact="'I added tradeware: ' + $addingWare.id " />
            <!-- <show_notification text="$notif" sound="null" /> -->
            <write_to_logbook category="general" title="'dumbmule: ' + this.ship.knownname +
                                                        ' ( ' + this.ship.idcode + ' )'"
                              interaction="showonmap" object="this.ship"
                              text="'Added tradeware ' + $addingWare + ' to ' + $dstStation.name + ' '" />
            <remove_value name="$notif" />

            <wait min="10ms" max="100ms" comment="Avoid performance peaks with find functions" />

            <!-- refresh trade offers from target -->
            <find_buy_offer buyer="$dstStation" result="$tradeOffers" multiple="true" excludeempty="false">
            </find_buy_offer>

            <!-- <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$tradeOffers"
                 excludeempty="false" multiple="true"> -->
            <!--   <match_buyer> -->
            <!--        <match_gate_distance object="$srcStation" min="0"> -->
            <!--          <blacklist group="blacklistgroup.civilian" object="this.ship" /> -->
            <!--        </match_gate_distance> -->
            <!--   </match_buyer> -->
            <!-- </find_buy_offer> -->
          </do_if>

          <do_all exact="$tradeOffers.count" counter="$n">
            <set_value name="$tradeOffer" exact="$tradeOffers.{$n}" />

            <!-- <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                 text="'tradeOffer: ' + $tradeOffer + ' [' + $tradeOffer.ware.id + ']'" /> -->

            <do_if value="$addingWare == $tradeOffer.ware">
              <append_to_list name="$wareBasket" exact="$tradeOffer" />
              <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                             text="'adding ware '+$tradeOffer.ware+' to basket'" />
              <break />
            </do_if>
          </do_all>

        </do_if>
        <wait min="1ms" max="5ms" />
      </do_all>

      <!--create new list of wares, so we can shuffle it (randomize), not shuffling $wareBasket, because param-->
      <label name="tradableWares" />
      <set_value name="$tradableWares" exact="$wareBasket.clone" />


      <!-- trading -->


      <!--lets see if we actually have free space in cargo before trying to trade-->
      <do_if value="this.ship.cargo.free.container lt (this.ship.cargo.capacity.container/10)">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'  cargo is full'" />
        <resume label="noTradesPossible" />
      </do_if>

      <set_value name="$isReturn" exact="false" />

      <label name="returnTrades" />

      <!--does target station have room to trade?-->
      <do_if value="$dstStation.cargo.free.container lt ($dstStation.cargo.capacity.container/10)">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'  cargo at destination station is full (isReturn:'+$isReturn+')'" />
        <resume label="planReturn" />
      </do_if>


      <set_value name="$loadvol" exact="0" />

      <set_value name="$prio1" exact="[]" />
      <set_value name="$prio2" exact="[]" />
      <set_value name="$prio3" exact="[]" />
      <set_value name="$prio4" exact="[]" />
      <set_value name="$prio5" exact="[]" />

      <shuffle_list list="$tradableWares" />

      <do_all exact="$tradableWares.count" counter="$tradableWare">
        <wait min="10ms" max="100ms" comment="Avoid performance peaks with find functions" />
        <set_value name="$currentOffer" exact="$tradableWares.{$tradableWare}" />
        <set_value name="$currentWare" exact="$currentOffer.ware" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'ware: '+$currentWare+'. minprice: '+$currentWare.minprice+
                             '. maxprice: '+$currentWare.maxprice+'. average: '+$currentWare.averageprice" />

        <set_value
            name="$cargoRatio"
            exact="($dstStation.cargo.{$currentWare}.count * 100) / [$dstStation.cargo.{$currentWare}.target, 1].max" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'cargoRatio '+$currentWare+': '+ $cargoRatio" />

        <do_if value="(not $isReturn) and ($dstStation.cargo.{$currentWare}.count == 0)">
          <set_value name="$cargoRatio" exact="0" />
        </do_if>

        <do_if value="$cargoRatio lt 10">
          <append_to_list name="$prio1" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="$currentWare+' added to prio1 list'" />
        </do_if>
        <do_elseif value="$cargoRatio lt 25">
          <append_to_list name="$prio2" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="$currentWare+' added to prio2 list'" />
        </do_elseif>
        <do_elseif value="$cargoRatio lt 50">
          <append_to_list name="$prio3" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="$currentWare+' added to prio3 list'" />
        </do_elseif>
        <do_elseif value="$cargoRatio lt 75">
          <append_to_list name="$prio4" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="$currentWare+' added to prio4 list'" />
        </do_elseif>
        <do_elseif value="$cargoRatio lt 150">
          <append_to_list name="$prio5" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="$currentWare+' added to prio5 list'" />
        </do_elseif>
        <do_else>
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="$currentWare+' skipped because cargoRatio > 150%'" />
        </do_else>
      </do_all>

      <set_value name="$wareList" exact="[]" />

      <do_all exact="$prio1.count" counter="$p1">
        <append_to_list name="$wareList" exact="$prio1.{$p1}" />
      </do_all>
      <do_all exact="$prio2.count" counter="$p2">
        <append_to_list name="$wareList" exact="$prio2.{$p2}" />
      </do_all>
      <do_all exact="$prio3.count" counter="$p3">
        <append_to_list name="$wareList" exact="$prio3.{$p3}" />
      </do_all>
      <do_all exact="$prio4.count" counter="$p4">
        <append_to_list name="$wareList" exact="$prio4.{$p4}" />
      </do_all>
      <do_all exact="$prio5.count" counter="$p5">
        <append_to_list name="$wareList" exact="$prio5.{$p5}" />
      </do_all>

      <remove_value name="$prio1" />
      <remove_value name="$prio2" />
      <remove_value name="$prio3" />
      <remove_value name="$prio4" />
      <remove_value name="$prio5" />

      <!-- create trades -->
      <do_all exact="$wareList.count" counter="$idx">

        <set_value name="$buyOffer" exact="$wareList.{$idx}" />
        <set_value name="$ware" exact="$buyOffer.ware" />

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="$ware + ' ship.cargo.free: ' + this.ship.cargo.{$ware}.free +
                             '  :: srcStation.cargo.ware.count: ' + $srcStation.cargo.{$ware}.count " />

        <do_if value="$srcStation.cargo.{$ware}.count == 0">
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'skipping ' + $ware + ' as available amount is 0'" />
          <continue />
        </do_if>

        <set_value name="$cargoHauled" exact="[this.ship.cargo.{$ware}.free,$srcStation.cargo.{$ware}.count].min" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'ware: ' + $ware + ' [' + $ware.id + ']; amount: ' + $cargoHauled" />

        <wait min="10ms" max="100ms" comment="Avoid performance peaks with find functions" />
        <find_sell_offer seller="$srcStation" result="$sellOffers" multiple="true" excludeempty="false">
        </find_sell_offer>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'sellOffers count: ' + $sellOffers.count" />

        <set_value name="$sellOfferFound" exact="false" />

        <do_all exact="$sellOffers.count" counter="$so">
          <set_value name="$sellOffer" exact="$sellOffers.{$so}" />

          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'sellOffer: ' + $sellOffer.ware + ' [' + $sellOffer.ware.id + ']'" />

          <do_if value="$sellOffer.ware == $ware">
            <set_value name="$sellOfferFound" exact="true" />
            <create_trade_order name="$getWare" object="this.object" tradeoffer="$sellOffer"
                                amount="$cargoHauled" immediate="false" />

            <break />
          </do_if>
        </do_all>

        <do_if value="$sellOfferFound">
          <create_trade_order name="$dropWare" object="this.object" tradeoffer="$buyOffer"
                              amount="$cargoHauled" immediate="false" />

          <set_value name="$cargoVolume" exact="$cargoHauled * $ware.volume" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'ship cargo cap: ' + this.ship.cargo.capacity.all +
                               '; ware vol: ' + $ware.volume + ' * ' + $cargoHauled + ' = ' + $cargoVolume" />

          <set_value name="$cargoPerc" exact="($cargoVolume * 100) / this.ship.cargo.capacity.all" />

          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'moving ' + $cargoHauled + ' ' + $ware +
                               ' (' + $cargoVolume + ' : ' + $cargoPerc + '% filled)' +
                               ' from ' + $srcStation.name +
                               ' to ' + $dstStation.name " />

          <write_to_logbook category="upkeep" title="'OnlyMule: '+this.ship.knownname+' ( '+this.ship.idcode+' )'"
                            interaction="showonmap"
                            object="this.ship"
                            text="'Transporting ' + $cargoHauled + ' ' + $ware + ' from ' + $srcStation.name +
                                  ' to ' + $dstStation.name" />
        </do_if>
        <do_else>
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'NOT moving ' +$cargoHauled + ' ' + $ware +
                               ' from ' +$srcStation.owner.knownname +
                               ' to ' +$dstStation.owner.knownname + ': ERROR'" />
        </do_else>

        <!-- do we have room for more? -->
        <!-- <set_value name="$loadvol" exact="$loadvol + ($ware.volume * $cargoHauled)" /> -->
        <!-- <do_if value="(($loadvol / this.ship.cargo.cargo.capacity.all) * 100) lt 60"> -->
        <!--   <resume label="moreTrades" /> -->
        <!-- </do_if> -->
        <!-- <do_else> -->

        <!-- for now, leave it at that... -->
        <break/>

        <!-- </do_else> -->
      </do_all>



      <!-- if not twoWay, we're done... -->
      <do_if value="not $twoWay">
        <resume label="finish" />
      </do_if>

      <label name="planReturn" />

      <!-- did we already do the return trip? -->
      <do_if value="not $isReturn">
        <set_value name="$isReturn" exact="true" />

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'  starting return calculations...'" />

        <!-- rearrange src and dst -->
        <set_value name="$sourceWares" exact="$tradableWares" />

        <set_value name="$potentialWares" exact="[]" />
        <set_value name="$tradableWares" exact="[]" />

        <set_value name="$srcStation" exact="$targetStation" />
        <set_value name="$dstStation" exact="$sourceStation" />


        <!-- product wares -->
        <do_all exact="$srcStation.products.count" counter="$cts">
          <set_value name="$addingWare" exact="$srcStation.products.{$cts}" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'scanning return ware: ' + $addingWare + ' [' + $addingWare.id + ']'" />

          <!-- SKIP ENERGY CELLS -->
          <do_if value="$addingWare.id == 'energycells'">
            <continue/>
          </do_if>

          <do_if value="$potentialWares.indexof.{$addingWare}" negate="true">
            <do_if value="$sourceWares.indexof.{$addingWare}" negate="true"> <!-- skip wares we just brought here -->
              <append_to_list name="$potentialWares" exact="$addingWare" />
              <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                             text="'adding return ware ' + $addingWare + ' to potential basket'" />
            </do_if>
          </do_if>
          <wait min="1ms" max="5ms" />
        </do_all>

        <!-- trade wares -->
        <do_all exact="$srcStation.tradewares.count" counter="$cts">
          <set_value name="$addingWare" exact="$srcStation.tradewares.{$cts}" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'scanning return trade ware: '+$addingWare" />

          <!-- SKIP ENERGY CELLS -->
          <do_if value="$addingWare.id == 'energycells'">
            <continue/>
          </do_if>

          <do_if value="$potentialWares.indexof.{$addingWare}" negate="true">
            <do_if value="$sourceWares.indexof.{$addingWare}" negate="true"> <!-- skip wares we just brought here -->
              <append_to_list name="$potentialWares" exact="$addingWare" />
              <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                             text="'adding return trade ware '+$addingWare+' to potential basket'" />
            </do_if>
          </do_if>
          <!-- <wait min="1ms" max="5ms" /> -->
        </do_all>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'find buyOffers'" />

        <!-- figure out what wares the source station actually wants -->
        <!-- <wait min="50ms" max="100ms" comment="Avoid performance peaks with find functions"/> -->
        <!-- <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$needs" multiple="true"> -->
        <!--   <amount min="1" /> -->
        <!-- </find_buy_offer> -->
        <wait min="10ms" max="100ms" comment="Avoid performance peaks with find functions" />
        <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$needs"
                        excludeempty="false" multiple="true">
          <match_buyer>
            <match_gate_distance object="$srcStation" min="0">
              <blacklist group="blacklistgroup.civilian" object="this.ship" />
            </match_gate_distance>
          </match_buyer>
        </find_buy_offer>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'buyOffers count: ' + $needs.count" />


        <do_all exact="$needs.count" counter="$n">
          <set_value name="$trade" exact="$needs.{$n}" />

          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'trade in needs: ' + $trade + ' : ' + $trade.ware" />

          <do_if value="$potentialWares.indexof.{$trade.ware}">
            <append_to_list name="$tradableWares" exact="$trade" />
            <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                           text="'adding return trade for '+$trade.ware+' to basket'" />
          </do_if>
        </do_all>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'now going to do return trades...'" />

        <resume label="returnTrades" />
      </do_if>

      <resume label="finish" />

      <label name="noTradesPossible" />
      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                     text="'--- NO POSSIBLE TRADES FOUND ---'" />

      <label name="finish" />

      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'    end'" />

      <remove_value name="$srcStation" />
      <remove_value name="$dstStation" />
      <remove_value name="$wareBasket" />


      <wait min="3min" max="5min" />
      <label name="end" />
    </actions>
  </attention>
</aiscript>
