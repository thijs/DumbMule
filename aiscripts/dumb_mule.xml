<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="dumbmule" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://x4libonline.ddns.net\libraries\aiscripts.xsd" version="5">
  <!-- Setup context menu order -->
  <order id="DumbMule" name="M5- Dumb Mule" description="Dumbly ferries supplies between stations" category="trade" infinite="true">
    <params>
      <!-- menu option: Source Station (Define Source Station) -->
      <param name="sourceStation" type="object" text="Source Station" comment="The source station">
        <input_param name="class" value="[class.station]" />
      </param>
      <!-- menu option: Target Station (Defines destination target) -->
      <param name="targetStation" type="object" text="Target Station" comment="The recipient station">
        <input_param name="class" value="[class.station]" />
      </param>
      <!-- menu option: Assign Ship to Station (Are we assigning this ship to a station if player owned.) -->
      <param name="assignSrc" type="bool" default="false" text="Assign Ship To Station" comment="Assign to the source station if it's the players." />
      <!-- menu option: Include Energry Wares (Inlcudes energry cells if used) -->
      <param name="incEgry" type="bool" default="false" text="Include Energy Cells" comment="Includes energy cells in the supply" />
      <!-- menu option: Include Food & Medical Wares (Inlcudes food and medical wares if used) -->
      <param name="incFood" type="bool" default="false" text="Include Food and Meds" comment="Includes food and meds in the supply" />
      <!-- menu option: Supply First (Prioritize emptying sellers ware stocks if used) -->
      <param name="supplyFirst" type="bool" default="false" text="Seller Priority" comment="Put the priority on emptying the seller's stocks" />
      <!-- menu option: Drug Free (Never trade illegal wares if used) -->
      <param name="drugFree" type="bool" default="false" text="Never Illegal " comment="Never trades illegal wares" />
      <!-- menu option: Drugs Only (Only trade illegal wares if used) -->
      <param name="drugsOnly" type="bool" default="false" text="Illegal Only" comment="Trade only illegal wares" />
      <!-- menu option: Two-way Trade (Forces trading back and forth between the stations if used) -->
      <param name="twoWay" type="bool" default="false" text="Two-way trade" comment="Trades back and forth between stations" />
      <!-- menu option: Return Seller Priority (Forces seller priority on return if used) -->
      <param name="twoWaySupplyFirst" type="bool" default="false" text="Return Seller Priority" comment="Seller priority on return trade" />
      <!-- menu option: No player in-system trade (Forbids all trades between all player owned objects in sector when ilde if used) -->
      <param name="forbidTradeAll" type="bool" default="false" text="No in-system trade" comment="Forbid trade between all player objects in system when idle" />
      <!-- menu option: Allow Low Volumes (Allow trades below 50% cargo capacity and below 80% cargo capacity for in-system trades if used) -->
      <param name="allowLowVol" type="bool" default="false" text="Allow Low Volumes" comment="Allow trades below 50% cargo, 80% for system trade" />
      <!-- menu option: Make Target Warehouse (Mule turns target station into functional Trade Station like NPC, which can buy everything the source sells if used) -->
      <param name="allowCreateTrade" type="bool" default="false" text="Make Target Warehouse" comment="Allow mules to force Target to buy all the Source sells." />
    </params>
    <requires>
      <!-- The requirements of ships in order to be eligible get this order (requirements can be skill-level requirements or ship-type requirements) -->
      <!-- This denies laser towers from being able to get this order (more precisely in our case, this default behaviour) -->
      <match shiptype="shiptype.lasertower" negate="true" />
    </requires>
  </order>

  <interrupts>
    <handler ref="AttackHandler" />
    <handler ref="MissileLockHandler" />
    <handler ref="ScannedHandler" />
    <handler ref="InspectedHandler" />
    <handler ref="FoundAbandonedHandler" />
    <handler ref="ResupplyHandler" />
    <handler ref="JobRemoveRequestHandler" />
    <handler ref="TargetInvalidHandler" />
  </interrupts>

  <init>
    <set_value name="$debugchance" exact="100" />
    <set_value name="$object" exact="this.assignedcontrolled" />
    <set_order_syncpoint_reached order="this.ship.order" />
    <set_command_action commandaction="commandaction.searchingtrades" />
    <do_if value="($sourceStation.owner == this.ship.owner)">
      <set_object_commander object="this.ship" commander="$sourceStation" assignment="assignment.trade" />
    </do_if>
    <set_value name="$debugFileName" exact="'dumbmule- ' + this.ship.idcode" />
  </init>

  <attention min="unknown">
    <actions>
      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'starting log file'" append="false" output="false" />

      <label name="start" />


      <set_value name="$srcStation" exact="$sourceStation" />
      <set_value name="$dstStation" exact="$targetStation" />

      <set_value name="$wareBasket" exact="[]" />

      <!-- get existing trade offers from target -->
      <find_buy_offer buyer="$dstStation" result="$tradeOffers" multiple="true" excludeempty="false">
      </find_buy_offer>

      <!-- <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$tradeOffers" excludeempty="false" multiple="true"> -->
      <!--      <match_buyer> -->
      <!--        <match_gate_distance object="$srcStation" min="0"> -->
      <!--          <blacklist group="blacklistgroup.civilian" object="this.ship" /> -->
      <!--        </match_gate_distance> -->
      <!--      </match_buyer> -->
      <!-- </find_buy_offer> -->
      <wait min="5ms" max="15ms" />

      <!-- product wares -->
      <do_all exact="$srcStation.products.count" counter="$cts">
        <set_value name="$addingWare" exact="$srcStation.products.{$cts}" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'scanning ware: ' + $addingWare + ' [' + $addingWare.id + ']'" />

        <!-- SKIP ENERGY CELLS -->
        <do_if value="$addingWare.id == 'energycells'">
          <continue/>
        </do_if>

        <do_if value="$wareBasket.indexof.{$addingWare}" negate="true">

          <!-- get it as offer -->
          <set_value name="$offerFound" exact="false" />
          <do_all exact="$tradeOffers.count" counter="$n">

            <!-- <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'tradeOffer: ' + $tradeOffers.{$n}.ware + ' [' + $tradeOffers.{$n}.ware.id + ']'" /> -->

            <do_if value="$addingWare == $tradeOffers.{$n}.ware">
              <set_value name="$offerFound" exact="true" />
              <break />
            </do_if>
          </do_all>

          <do_if value="not $offerFound">

            <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                           text="'no tradeOffer: adding now for ' + $addingWare" />
            <add_tradeware object="$dstStation" ware="$addingWare" allowbuy="true" allowsell="true" lockavgprice="false" />
            <wait min="2ms" max="5ms" />

            <!-- refresh trade offers from target -->
            <find_buy_offer buyer="$dstStation" result="$tradeOffers" multiple="true" excludeempty="false">
            </find_buy_offer>

            <!-- <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$tradeOffers" excludeempty="false" multiple="true"> -->
            <!--   <match_buyer> -->
            <!--        <match_gate_distance object="$srcStation" min="0"> -->
            <!--          <blacklist group="blacklistgroup.civilian" object="this.ship" /> -->
            <!--        </match_gate_distance> -->
            <!--   </match_buyer> -->
            <!-- </find_buy_offer> -->
          </do_if>

          <do_all exact="$tradeOffers.count" counter="$n">
            <set_value name="$tradeOffer" exact="$tradeOffers.{$n}" />

            <!-- <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'tradeOffer: ' + $tradeOffer + ' [' + $tradeOffer.ware.id + ']'" /> -->

            <do_if value="$addingWare == $tradeOffer.ware">
              <append_to_list name="$wareBasket" exact="$tradeOffer" />
              <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'adding ware '+$tradeOffer.ware+' to basket'" />
              <break />
            </do_if>
          </do_all>

        </do_if>
        <wait min="1ms" max="5ms" />
      </do_all>

      <!--create new list of wares, so we can shuffle it (randomize), not shuffling $wareBasket, because param-->
      <label name="tradableWares" />
      <set_value name="$tradableWares" exact="$wareBasket.clone" />


      <!-- trading -->


      <!--lets see if we actually have free space in cargo before trying to trade-->
      <do_if value="this.ship.cargo.free.container lt (this.ship.cargo.capacity.container/10)">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'  cargo is full =('" />
        <resume label="noTradesPossible" />
      </do_if>

      <set_value name="$isReturn" exact="false" />

      <label name="returnTrades" />

      <!--does target station have room to trade?-->
      <do_if value="$dstStation.cargo.free.container lt ($dstStation.cargo.capacity.container/10)">
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'  cargo at destination station is full (isReturn:'+$isReturn+')'" />
        <resume label="noTradesPossible" />
      </do_if>


      <set_value name="$loadvol" exact="0" />

      <set_value name="$prio1" exact="[]" />
      <set_value name="$prio2" exact="[]" />
      <set_value name="$prio3" exact="[]" />
      <set_value name="$prio4" exact="[]" />
      <set_value name="$prio5" exact="[]" />

      <shuffle_list list="$tradableWares" />

      <do_all exact="$tradableWares.count" counter="$tradableWare">
        <!-- <wait min="1ms" max="100ms" comment="Avoid performance peaks with find functions" /> -->
        <set_value name="$currentOffer" exact="$tradableWares.{$tradableWare}" />
        <set_value name="$currentWare" exact="$currentOffer.ware" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'ware: '+$currentWare+'. minprice: '+$currentWare.minprice+
                       '. maxprice: '+$currentWare.maxprice+'. average: '+$currentWare.averageprice" />

        <set_value name="$cargoRatio" exact="($dstStation.cargo.{$currentWare}.count * 100) / [$dstStation.cargo.{$currentWare}.target, 1].max" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'cargoRatio '+$currentWare+': '+ $cargoRatio" />

        <do_if value="(not $isReturn) and ($dstStation.cargo.{$currentWare}.count == 0)">
          <set_value name="$cargoRatio" exact="0" />
        </do_if>

        <do_if value="$cargoRatio lt 10">
          <append_to_list name="$prio1" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="$currentWare+' added to prio1 list'" />
        </do_if>
        <do_elseif value="$cargoRatio lt 25">
          <append_to_list name="$prio2" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="$currentWare+' added to prio2 list'" />
        </do_elseif>
        <do_elseif value="$cargoRatio lt 50">
          <append_to_list name="$prio3" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="$currentWare+' added to prio3 list'" />
        </do_elseif>
        <do_elseif value="$cargoRatio lt 75">
          <append_to_list name="$prio4" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="$currentWare+' added to prio4 list'" />
        </do_elseif>
        <do_else>
          <append_to_list name="$prio5" exact="$currentOffer" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="$currentWare+' added to prio5 list'" />
        </do_else>
      </do_all>

      <set_value name="$wareList" exact="[]" />

      <do_all exact="$prio1.count" counter="$p1">
        <append_to_list name="$wareList" exact="$prio1.{$p1}" />
      </do_all>
      <do_all exact="$prio2.count" counter="$p2">
        <append_to_list name="$wareList" exact="$prio2.{$p2}" />
      </do_all>
      <do_all exact="$prio3.count" counter="$p3">
        <append_to_list name="$wareList" exact="$prio3.{$p3}" />
      </do_all>
      <do_all exact="$prio4.count" counter="$p4">
        <append_to_list name="$wareList" exact="$prio4.{$p4}" />
      </do_all>
      <do_all exact="$prio5.count" counter="$p5">
        <append_to_list name="$wareList" exact="$prio5.{$p5}" />
      </do_all>

      <remove_value name="$prio1" />
      <remove_value name="$prio2" />
      <remove_value name="$prio3" />
      <remove_value name="$prio4" />
      <remove_value name="$prio5" />

      <!-- create trades -->
      <do_all exact="$wareList.count" counter="$idx">

        <set_value name="$buyOffer" exact="$wareList.{$idx}" />
        <set_value name="$ware" exact="$buyOffer.ware" />

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="$ware + ' ship.cargo.free: ' + this.ship.cargo.{$ware}.free +
                             '  :: srcStation.cargo.ware.count: ' + $srcStation.cargo.{$ware}.count " />

        <do_if value="$srcStation.cargo.{$ware}.count == 0">
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'skipping ' + $ware + ' as available amount is 0'" />
          <continue />
        </do_if>

        <set_value name="$cargoHauled" exact="[this.ship.cargo.{$ware}.free,$srcStation.cargo.{$ware}.count].min" />
        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'ware: ' + $ware + ' [' + $ware.id + ']; amount: ' + $cargoHauled" />

        <find_sell_offer seller="$srcStation" result="$sellOffers" multiple="true" excludeempty="false">
        </find_sell_offer>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'sellOffers count: ' + $sellOffers.count" />

        <set_value name="$sellOfferFound" exact="false" />

        <do_all exact="$sellOffers.count" counter="$so">
          <set_value name="$sellOffer" exact="$sellOffers.{$so}" />

          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'sellOffer: ' + $sellOffer.ware + ' [' + $sellOffer.ware.id + ']'" />

          <do_if value="$sellOffer.ware == $ware">
            <set_value name="$sellOfferFound" exact="true" />
            <create_trade_order name="$getWare" object="this.object" tradeoffer="$sellOffer" amount="$cargoHauled" immediate="false" />

            <break />
          </do_if>
        </do_all>

        <do_if value="$sellOfferFound">
          <create_trade_order name="$dropWare" object="this.object" tradeoffer="$buyOffer" amount="$cargoHauled" immediate="false" />

          <set_value name="$cargoVolume" exact="$cargoHauled * $ware.volume" />
          <set_value name="$cargoPerc" exact="($cargoVolume / this.ship.cargo.capacity.all) * 100" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'cargoPerc: ' + $cargoPerc" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'ship cargo: ' + this.ship.cargo.capacity.all" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'moving ' + $cargoHauled + ' ' + $ware +
                               ' (' + $cargoVolume + ' : ' + $cargoPerc + '% filled)' +
                               ' from ' + $srcStation.name +
                               ' to ' + $dstStation.name " />

          <write_to_logbook category="upkeep" title="'OnlyMule: '+this.ship.knownname+' ( '+this.ship.idcode+' )'"
                            interaction="showonmap"
                            object="this.ship"
                            text="'Transporting ' + $cargoHauled + ' ' + $ware + ' from ' + $srcStation.name +
                                  ' to ' + $dstStation.name" />
        </do_if>
        <do_else>
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'NOT moving ' +$cargoHauled + ' ' + $ware +
                               ' from ' +$srcStation.owner.knownname +
                               ' to ' +$dstStation.owner.knownname + ': ERROR'" />
        </do_else>

        <!-- do we have room for more? -->
        <!-- <set_value name="$loadvol" exact="$loadvol + ($ware.volume * $cargoHauled)" /> -->
        <!-- <do_if value="(($loadvol / this.ship.cargo.cargo.capacity.all) * 100) lt 60"> -->
        <!--   <resume label="moreTrades" /> -->
        <!-- </do_if> -->
        <!-- <do_else> -->

        <!-- for now, leave it at that... -->
        <break/>

        <!-- </do_else> -->

      </do_all>

      <!-- did we already do the return trip? -->
      <do_if value="not $isReturn">
        <set_value name="$isReturn" exact="true" />

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'  starting return calculations...'" />

        <!-- rearrange src and dst -->
        <set_value name="$sourceWares" exact="$tradableWares" />

        <set_value name="$potentialWares" exact="[]" />
        <set_value name="$tradableWares" exact="[]" />

        <set_value name="$srcStation" exact="$targetStation" />
        <set_value name="$dstStation" exact="$sourceStation" />


        <!-- product wares -->
        <do_all exact="$srcStation.products.count" counter="$cts">
          <set_value name="$addingWare" exact="$srcStation.products.{$cts}" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'scanning return ware: ' + $addingWare + ' [' + $addingWare.id + ']'" />

          <!-- SKIP ENERGY CELLS -->
          <do_if value="$addingWare.id == 'energycells'">
            <continue/>
          </do_if>

          <do_if value="$potentialWares.indexof.{$addingWare}" negate="true">
            <do_if value="$sourceWares.indexof.{$addingWare}" negate="true"> <!-- skip wares we just brought here -->
              <append_to_list name="$potentialWares" exact="$addingWare" />
              <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'adding return ware ' + $addingWare + ' to potential basket'" />
            </do_if>
          </do_if>
          <wait min="1ms" max="5ms" />
        </do_all>

        <!-- trade wares -->
        <do_all exact="$srcStation.tradewares.count" counter="$cts">
          <set_value name="$addingWare" exact="$srcStation.tradewares.{$cts}" />
          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'scanning return trade ware: '+$addingWare" />

          <!-- SKIP ENERGY CELLS -->
          <do_if value="$addingWare.id == 'energycells'">
            <continue/>
          </do_if>

          <do_if value="$potentialWares.indexof.{$addingWare}" negate="true">
            <do_if value="$sourceWares.indexof.{$addingWare}" negate="true"> <!-- skip wares we just brought here -->
              <append_to_list name="$potentialWares" exact="$addingWare" />
              <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'adding return trade ware '+$addingWare+' to potential basket'" />
            </do_if>
          </do_if>
          <!-- <wait min="1ms" max="5ms" /> -->
        </do_all>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'find buyOffers'" />

        <!-- figure out what wares the source station actually wants -->
        <!-- <wait min="50ms" max="100ms" comment="Avoid performance peaks with find functions"/> -->
        <!-- <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$needs" multiple="true"> -->
        <!--   <amount min="1" /> -->
        <!-- </find_buy_offer> -->
        <find_buy_offer tradepartner="this.ship" buyer="$dstStation" result="$needs" excludeempty="false" multiple="true">
          <match_buyer>
            <match_gate_distance object="$srcStation" min="0">
              <blacklist group="blacklistgroup.civilian" object="this.ship" />
            </match_gate_distance>
          </match_buyer>
        </find_buy_offer>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'buyOffers count: ' + $needs.count" />


        <do_all exact="$needs.count" counter="$n">
          <set_value name="$trade" exact="$needs.{$n}" />

          <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                         text="'trade in needs: ' + $trade + ' : ' + $trade.ware" />

          <do_if value="$potentialWares.indexof.{$trade.ware}">
            <append_to_list name="$tradableWares" exact="$trade" />
            <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                           text="'adding return trade for '+$trade.ware+' to basket'" />
          </do_if>
        </do_all>

        <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'"
                       text="'now going to do return trades...'" />

        <resume label="returnTrades" />
      </do_if>

      <resume label="finish" />

      <label name="noTradesPossible" />
      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'--- NO POSSIBLE TRADES FOUND ---'" />
      <!-- <set_value name="this.$randomXIdling" exact="1" /> -->
      <!--I could not find any trade for the required min profit, maybe scale down (use slider)? visit more stations/deploy more sattelites-->
      <!-- <wait min="120s" max="200s" /> -->

      <label name="finish" />

      <debug_to_file chance="$debugchance" name="$debugFileName" directory="'DumbMule'" text="'    end'" />

      <remove_value name="$srcStation" />
      <remove_value name="$dstStation" />
      <remove_value name="$wareBasket" />


      <wait min="3min" max="5min" />
      <label name="end" />
    </actions>
  </attention>
</aiscript>
